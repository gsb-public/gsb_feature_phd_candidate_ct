<?php
/**
 * @file
 * Code for the GSB Feature PhD Candidate CT feature.
 */

include_once 'gsb_feature_phd_candidate_ct.features.inc';

/**
 * Implements hook_form_alter().
 */
function gsb_feature_phd_candidate_ct_form_phd_candidate_node_form_alter(&$form, &$form_state, $form_id) {
  // add a validation function
  $form['#validate'][] = 'gsb_feature_phd_candidate_ct_validate';
  dpm($form['field_person_fac_ref']['und']);

  // If the user doesn't have 'edit any' access for the phd candidate content
  // then this is just an authenticated user, and only access to edit their own
  // phd candidate profile.
  // If true, we will modify several function of the node edit form
  if (!user_access('edit any phd_candidate content')) {
    // remove these fields
    $form['revision_information']['#access'] = false;
    $form['field_job_display']['#access'] = false;
    $form['field_year']['#access'] = false;
    $form['field_academic_institution']['#access'] = false;
    // add a cancel button for the form
    $form['actions']['cancel'] = array(
      '#type' => 'submit',
      '#value' => t('Cancel'),
      '#submit' => array('gsb_feature_phd_candidate_ct_cancel_submit'),
    );
  }

  $form['actions']['preview_changes']['#access'] = false;

  $language = $form['language']['#value'];
  $form['field_academic_institution']['#states'] = array(
    'visible' => array(
      ':input[name="field_job_display[' . $language . ']"]' => array(
        array('value' => 'placement_page'),
      ),
    ),
  );

  $form['field_year']['#states'] = array(
    'visible' => array(
      ':input[name="field_job_display[' . $language . ']"]' => array(
        array('value' => 'placement_page'),
      ),
    ),
  );
}

function gsb_feature_phd_candidate_ct_validate($form, &$form_state) {
  // always force the content to be published
  // if the user is someone that doesn't have the 'edit any' permission
  // this should be any phd student, who would only have the 'edit own' permission
  if (!user_access('edit any phd_candidate content')) {
    $form_state['values']['workbench_moderation_state_new'] = 'published';
  }

  // check if user set as the author exists
  // if not, then we will create the user
  $author_name = $form_state['values']['name'];
  if (!$author_user = user_load_by_name($author_name)) {
    //set up the user fields
    $fields = array(
      'name' => $author_name,
      'mail' => $author_name . '@stanford.edu',
      'pass' => user_password(),
      'status' => 1,
      'init' => 'gsb_feature_phd_candidate_ct',
      'roles' => array(
        DRUPAL_AUTHENTICATED_RID => 'authenticated user',
      ),
    );
    user_save(drupal_anonymous_user(), $fields);
  } 
}

/**
 * Redirect the submitted form, if the user has click on the cancel button.
 */
function gsb_feature_phd_candidate_ct_cancel_submit($form, &$form_state) {
  $form_state['redirect'] = $form_state['node']->path['alias'];
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function gsb_feature_phd_candidate_ct_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  if (($node = menu_get_object()) && $node->type == 'phd_candidate' && !user_access('edit any phd_candidate content')) {
    // The user is an authenticated user with access to edit their own 
    // phd candidate profile content.
    // Remove the 'View published' tab, and change the wording for the
    // 'New draft' tab.
    foreach($data['tabs'][0]['output'] as $key => $value) {
      $title = $data['tabs'][0]['output'][$key]['#link']['title'];
      if ($title == 'View published') {
        unset($data['tabs'][0]['output'][$key]);
      } 
      if ($title == 'New draft') {
        $data['tabs'][0]['output'][$key]['#link']['title'] = 'Edit your Profile';
      }         
    } 
  }  
}  

